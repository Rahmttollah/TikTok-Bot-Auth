<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üëë Admin Panel - TikTok Bot System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #8B5FBF;
            --primary-dark: #6B46C1;
            --primary-light: #9F7AEA;
            --secondary: #D53F8C;
            --dark: #1A202C;
            --darker: #0F1419;
            --light: #EDF2F7;
            --success: #48BB78;
            --danger: #F56565;
            --warning: #ECC94B;
            --info: #4299E1;
        }
        
        body {
            background: linear-gradient(135deg, var(--darker) 0%, var(--dark) 50%, var(--primary-dark) 100%);
            min-height: 100vh;
            color: var(--light);
            animation: gradientShift 10s ease infinite;
            background-size: 400% 400%;
            overflow-x: hidden;
        }
        
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        
        .header {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(20px);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(139, 95, 191, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .logo h1 {
            font-size: 1.4em;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .btn-logout {
            padding: 10px 16px;
            background: rgba(245, 101, 101, 0.2);
            color: var(--light);
            border: 1px solid var(--danger);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
        }
        
        .btn-logout:hover {
            background: var(--danger);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px;
        }
        
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 20px;
            background: transparent;
            border: none;
            color: var(--light);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.9em;
            white-space: nowrap;
        }
        
        .tab.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }
        
        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .admin-panel {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 768px) {
            .admin-panel {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .panel-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(139, 95, 191, 0.3);
        }
        
        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            color: var(--primary-light);
            font-size: 1.2em;
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary-light);
            font-size: 1em;
        }
        
        input, select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(45, 55, 72, 0.8);
            border: 2px solid rgba(139, 95, 191, 0.3);
            border-radius: 10px;
            font-size: 16px;
            color: var(--light);
            transition: all 0.3s;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary-light);
            background: rgba(45, 55, 72, 1);
        }
        
        .btn-primary {
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            justify-content: center;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
        }
        
        .btn-primary.loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .btn-primary.loading::after {
            content: '';
            width: 18px;
            height: 18px;
            border: 2px solid transparent;
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .key-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 18px;
            border-radius: 10px;
            border: 2px dashed var(--primary-light);
            margin-top: 18px;
            text-align: center;
            display: none;
        }
        
        .key-value {
            font-family: 'Courier New', monospace;
            font-size: 1.1em;
            font-weight: bold;
            color: var(--primary-light);
            margin: 12px 0;
            word-break: break-all;
        }
        
        .btn-copy {
            padding: 10px 18px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
            font-weight: 600;
        }
        
        .btn-copy:hover {
            transform: translateY(-2px);
        }
        
        .users-section, .keys-section, .instances-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(139, 95, 191, 0.3);
            margin-bottom: 25px;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-direction: column;
            gap: 12px;
        }
        
        @media (min-width: 768px) {
            .section-header {
                flex-direction: row;
            }
        }
        
        .section-header h2 {
            color: var(--primary-light);
            font-size: 1.3em;
        }
        
        .users-list, .keys-list, .instances-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .user-item, .key-item, .instance-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 12px;
            border: 1px solid rgba(139, 95, 191, 0.2);
            flex-direction: column;
            gap: 12px;
        }
        
        @media (min-width: 768px) {
            .user-item, .key-item, .instance-item {
                flex-direction: row;
                gap: 0;
            }
        }
        
        .user-info, .key-info, .instance-info {
            flex: 1;
        }
        
        .user-name, .key-code, .instance-url {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--primary-light);
            font-size: 1em;
        }
        
        .user-email, .key-meta, .instance-meta {
            font-size: 0.85em;
            opacity: 0.7;
        }
        
        .user-bots {
            font-size: 0.8em;
            color: var(--info);
            margin-top: 5px;
        }
        
        .key-status, .instance-status, .user-role {
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.75em;
            font-weight: bold;
            white-space: nowrap;
        }
        
        .status-used, .role-user {
            background: var(--danger);
            color: white;
        }
        
        .status-unused, .role-super_admin, .role-sub_admin {
            background: var(--success);
            color: white;
        }
        
        .btn-delete, .btn-promote, .btn-manage {
            padding: 8px 14px;
            background: var(--danger);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.3s;
            font-size: 0.8em;
            margin: 2px;
        }
        
        .btn-promote {
            background: var(--warning);
        }
        
        .btn-manage {
            background: var(--info);
        }
        
        .btn-delete:hover, .btn-promote:hover, .btn-manage:hover {
            transform: translateY(-2px);
        }
        
        .user-actions, .key-actions, .instance-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        @media (min-width: 768px) {
            .user-actions, .key-actions, .instance-actions {
                justify-content: flex-end;
            }
        }
        
        .alert {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .alert.success {
            background: rgba(72, 187, 120, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .alert.error {
            background: rgba(245, 101, 101, 0.2);
            border: 1px solid var(--danger);
            color: var(--danger);
        }
        
        .alert.info {
            background: rgba(66, 153, 225, 0.2);
            border: 1px solid var(--info);
            color: var(--info);
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            opacity: 0.7;
        }
        
        .empty-state i {
            font-size: 3em;
            margin-bottom: 15px;
            opacity: 0.5;
        }
        
        .stats-overview {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        
        @media (min-width: 768px) {
            .stats-overview {
                grid-template-columns: repeat(4, 1fr);
                gap: 20px;
            }
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(139, 95, 191, 0.3);
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 8px;
            background: linear-gradient(135deg, var(--primary-light), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .system-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(139, 95, 191, 0.3);
        }
        
        .bot-management {
            background: rgba(255, 255, 255, 0.1);
            padding: 18px;
            border-radius: 12px;
            margin-top: 15px;
            border: 1px solid var(--info);
        }
        
        .bot-list {
            max-height: 200px;
            overflow-y: auto;
            margin: 12px 0;
        }
        
        .bot-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            margin-bottom: 8px;
        }

        /* Instance Status Styles */
        .instance-available {
            color: var(--success);
            font-weight: bold;
        }
        
        .instance-allocated {
            color: var(--danger);
            font-weight: bold;
        }
        
        .instance-item.allocated {
            border: 2px solid var(--danger);
            background: rgba(245, 101, 101, 0.1);
        }
        
        .instance-item.available {
            border: 2px solid var(--success);
            background: rgba(72, 187, 120, 0.1);
        }
        
        /* Mobile Responsive */
        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }
            
            .logo h1 {
                font-size: 1.2em;
            }
            
            .user-menu {
                gap: 10px;
            }
            
            .btn-logout {
                padding: 8px 12px;
                font-size: 0.8em;
            }
            
            .container {
                padding: 15px 10px;
            }
            
            .panel-section {
                padding: 20px;
            }
            
            .section-title {
                font-size: 1.1em;
            }
            
            .users-section, .keys-section, .instances-section {
                padding: 20px;
            }
            
            .user-item, .key-item, .instance-item {
                padding: 15px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                flex-direction: column;
                gap: 10px;
                text-align: center;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                text-align: center;
            }
            
            .stats-overview {
                grid-template-columns: 1fr;
            }
            
            .user-actions, .key-actions, .instance-actions {
                justify-content: center;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <h1>üëë Admin Panel</h1>
        </div>
        <div class="user-menu">
            <span>Welcome, <span id="adminUsername">Admin</span></span>
            <button class="btn-logout" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>
    </div>
    
    <div class="container">
        <div class="system-info">
            <h4><i class="fas fa-info-circle"></i> System Information</h4>
            <div>Auth Server: <strong>Current Server</strong></div>
            <div>Main Controller: <strong>https://tiktok-main-controller-19o2.onrender.com</strong></div>
            <div>Admin Access: <strong id="adminRole">Full System Control</strong></div>
        </div>

        <div class="stats-overview">
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalKeys">0</div>
                <div class="stat-label">Registration Keys</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalInstances">0</div>
                <div class="stat-label">Bot Instances</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="activeInstances">0</div>
                <div class="stat-label">Active Instances</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('keys')">
                <i class="fas fa-key"></i> Registration Keys
            </button>
            <button class="tab" onclick="showTab('users')">
                <i class="fas fa-users"></i> Users
            </button>
            <button class="tab" onclick="showTab('instances')">
                <i class="fas fa-server"></i> Bot Instances
            </button>
        </div>

        <!-- Registration Keys Tab -->
        <div id="keys-tab" class="tab-content active">
            <div class="admin-panel">
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-key"></i>
                        <h2>Generate Registration Key</h2>
                    </div>
                    
                    <div class="form-group">
                        <label for="keyNote">Key Note (Optional)</label>
                        <input type="text" id="keyNote" placeholder="e.g., For VIP user">
                    </div>
                    
                    <button class="btn-primary" onclick="generateKey()" id="generateBtn">
                        <i class="fas fa-plus"></i> Generate Key
                    </button>
                    
                    <div class="key-display" id="keyDisplay">
                        <h3>üéâ Registration Key Generated!</h3>
                        <div class="key-value" id="generatedKey">XXXX-XXXX-XXXX</div>
                        <button class="btn-copy" onclick="copyKey()">
                            <i class="fas fa-copy"></i> Copy Key
                        </button>
                        <div style="margin-top: 12px; font-size: 0.85em; opacity: 0.8;">
                            Share this key with users for registration
                        </div>
                    </div>
                </div>
                
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        <h2>Instructions</h2>
                    </div>
                    
                    <div style="line-height: 1.6; opacity: 0.9; font-size: 0.9em;">
                        <p><strong>1.</strong> Generate registration keys for new users</p>
                        <p><strong>2.</strong> Users need these keys to create accounts</p>
                        <p><strong>3.</strong> Each key can be used only once</p>
                        <p><strong>4.</strong> Track key usage in the list below</p>
                        <p><strong>5.</strong> Each user gets 3 random bots automatically</p>
                    </div>
                </div>
            </div>
            
            <div class="keys-section">
                <div class="section-header">
                    <h2><i class="fas fa-key"></i> Registration Keys</h2>
                    <span id="keysCount">0 keys</span>
                </div>
                
                <div class="keys-list" id="keysList">
                    <div class="empty-state">
                        <i class="fas fa-key"></i>
                        <h3>No Keys Generated</h3>
                        <p>Generate your first registration key</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content">
            <div class="users-section">
                <div class="section-header">
                    <h2><i class="fas fa-users"></i> Registered Users</h2>
                    <span id="usersCount">0 users</span>
                </div>
                
                <div class="users-list" id="usersList">
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <h3>No Users Registered</h3>
                        <p>Users will appear here after registration</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bot Instances Tab -->
        <div id="instances-tab" class="tab-content">
            <div class="admin-panel">
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-plus-circle"></i>
                        <h2>Add Bot Instance</h2>
                    </div>
                    
                    <div class="form-group">
                        <label for="instanceUrl">Bot Instance URL</label>
                        <input type="url" id="instanceUrl" placeholder="https://tiktok-main-controller-19o2.onrender.com" required>
                    </div>
                    
                    <button class="btn-primary" onclick="addInstance()" id="addBtn">
                        <i class="fas fa-plus"></i> Add Instance
                    </button>
                </div>
                
                <div class="panel-section">
                    <div class="section-title">
                        <i class="fas fa-info-circle"></i>
                        <h2>Instructions</h2>
                    </div>
                    
                    <div style="line-height: 1.6; opacity: 0.9; font-size: 0.9em;">
                        <p><strong>1.</strong> Enter your bot instance URL</p>
                        <p><strong>2.</strong> Example: https://tiktok-main-controller-19o2.onrender.com</p>
                        <p><strong>3.</strong> Bot must have /start, /stop, /status endpoints</p>
                        <p><strong>4.</strong> New users get 3 random bots automatically</p>
                        <p><strong>5.</strong> Manage user bots in Users tab</p>
                    </div>
                </div>
            </div>
            
            <!-- Bot Distribution Controls -->
            <div class="panel-section" style="grid-column: 1 / -1; background: rgba(76, 175, 80, 0.1); border-color: #4CAF50;">
                <div class="section-title">
                    <i class="fas fa-robot"></i>
                    <h2>ü§ñ Auto Bot Distribution</h2>
                </div>
                
                <div id="distributionStatus">
                    <p>Loading distribution status...</p>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 15px;">
                    <button class="btn-primary" onclick="distributeBots()" id="distributeBtn" style="background: linear-gradient(135deg, #4CAF50, #45a049);">
                        <i class="fas fa-share-alt"></i> Distribute Bots Now
                    </button>
                    
                    <button class="btn-primary" onclick="checkDistributionStatus()" style="background: linear-gradient(135deg, #2196F3, #1976D2);">
                        <i class="fas fa-sync-alt"></i> Refresh Status
                    </button>
                </div>
                
                <div id="distributionResult" style="margin-top: 15px;"></div>
            </div>
            
            <div class="instances-section">
                <div class="section-header">
                    <h2><i class="fas fa-server"></i> Bot Instances</h2>
                    <span id="instancesCount">0 instances</span>
                </div>
                
                <div class="instances-list" id="instancesList">
                    <div class="empty-state">
                        <i class="fas fa-server"></i>
                        <h3>No Bot Instances</h3>
                        <p>Add your first bot instance to get started</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot Management Modal -->
    <div id="botManagementModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
        <div style="background: var(--dark); padding: 25px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                <h3 id="modalTitle">Manage User Bots</h3>
                <button onclick="closeBotModal()" style="background: var(--danger); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">‚úï</button>
            </div>
            <div id="modalContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <div id="message"></div>

    <script>
        let currentTab = 'keys';
        let currentUser = null;

        // Enhanced API call with error handling
        async function safeFetch(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                
                // Check if response is HTML instead of JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('text/html')) {
                    throw new Error('Server returned HTML instead of JSON');
                }
                
                const text = await response.text();
                
                try {
                    return JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    throw new Error('Invalid server response');
                }
            } catch (error) {
                console.error('Fetch Error:', error);
                throw error;
            }
        }

        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            event.target.classList.add('active');
            currentTab = tabName;
            
            // Load data for the tab
            if (tabName === 'keys') {
                loadKeys();
            } else if (tabName === 'users') {
                loadUsers();
            } else if (tabName === 'instances') {
                loadInstances();
                checkDistributionStatus();
            }
        }
        
        function showMessage(message, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = `<div class="alert ${type}">${message}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 5000);
        }
        
        function setLoading(buttonId, isLoading) {
            const btn = document.getElementById(buttonId);
            if (isLoading) {
                btn.classList.add('loading');
                if (buttonId === 'generateBtn') {
                    btn.innerHTML = '<i class="fas fa-spinner"></i> Generating...';
                } else if (buttonId === 'addBtn') {
                    btn.innerHTML = '<i class="fas fa-spinner"></i> Adding...';
                }
            } else {
                btn.classList.remove('loading');
                if (buttonId === 'generateBtn') {
                    btn.innerHTML = '<i class="fas fa-plus"></i> Generate Key';
                } else if (buttonId === 'addBtn') {
                    btn.innerHTML = '<i class="fas fa-plus"></i> Add Instance';
                }
            }
        }
        
        // Registration Keys Functions
        async function generateKey() {
            const note = document.getElementById('keyNote').value;
            
            setLoading('generateBtn', true);
            
            try {
                const data = await safeFetch('/api/admin/generate-key', {
                    method: 'POST',
                    body: JSON.stringify({ note: note })
                });
                
                if (data.success) {
                    document.getElementById('generatedKey').textContent = data.key;
                    document.getElementById('keyDisplay').style.display = 'block';
                    showMessage('Registration key generated successfully!', 'success');
                    loadKeys();
                    updateStats();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error generating key: ' + error.message, 'error');
            } finally {
                setLoading('generateBtn', false);
            }
        }
        
        async function copyKey() {
            const key = document.getElementById('generatedKey').textContent;
            try {
                await navigator.clipboard.writeText(key);
                showMessage('Key copied to clipboard!', 'success');
            } catch (error) {
                showMessage('Failed to copy key', 'error');
            }
        }
        
        async function loadKeys() {
            try {
                const data = await safeFetch('/api/admin/keys');
                
                const keysList = document.getElementById('keysList');
                document.getElementById('keysCount').textContent = `${data.keys.length} keys`;
                
                if (data.keys.length === 0) {
                    keysList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-key"></i>
                            <h3>No Keys Generated</h3>
                            <p>Generate your first registration key</p>
                        </div>
                    `;
                    return;
                }
                
                keysList.innerHTML = '';
                
                data.keys.forEach(key => {
                    const keyItem = document.createElement('div');
                    keyItem.className = 'key-item';
                    keyItem.innerHTML = `
                        <div class="key-info">
                            <div class="key-code">${key.key}</div>
                            <div class="key-meta">
                                Created: ${new Date(key.createdAt).toLocaleDateString()}
                                ${key.note ? ` | Note: ${key.note}` : ''}
                                ${key.used ? ` | Used by: ${key.usedBy}` : ''}
                            </div>
                        </div>
                        <div class="key-actions">
                            <span class="key-status ${key.used ? 'status-used' : 'status-unused'}">
                                ${key.used ? 'USED' : 'UNUSED'}
                            </span>
                            ${!key.used ? `
                                <button class="btn-delete" onclick="deleteKey('${key.key}')">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            ` : ''}
                        </div>
                    `;
                    keysList.appendChild(keyItem);
                });
            } catch (error) {
                console.log('Error loading keys:', error);
                showMessage('Error loading keys', 'error');
            }
        }
        
        // ‚úÖ FIXED DELETE KEY FUNCTION
        async function deleteKey(key) {
            if (!confirm('Are you sure you want to delete this registration key?')) {
                return;
            }
            
            try {
                showMessage('Deleting key...', 'info');
                
                const response = await fetch(`/api/admin/keys/${key}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('‚úÖ Key deleted successfully!', 'success');
                    loadKeys();
                    updateStats();
                } else {
                    showMessage(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error deleting key: ' + error.message, 'error');
            }
        }
        
        // Users Functions
        async function loadUsers() {
            try {
                const data = await safeFetch('/api/admin/users');
                
                const usersList = document.getElementById('usersList');
                document.getElementById('usersCount').textContent = `${data.users.length} users`;
                
                if (data.users.length === 0) {
                    usersList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h3>No Users Registered</h3>
                            <p>Users will appear here after registration</p>
                        </div>
                    `;
                    return;
                }
                
                usersList.innerHTML = '';
                
                data.users.forEach(user => {
                    const userItem = document.createElement('div');
                    userItem.className = 'user-item';
                    userItem.innerHTML = `
                        <div class="user-info">
                            <div class="user-name">${user.username}</div>
                            <div class="user-email">${user.email}</div>
                            <div class="user-bots">Bots: ${user.allocatedBots?.length || 0}/3 allocated</div>
                            <div class="user-meta">
                                Registered: ${new Date(user.createdAt).toLocaleDateString()} | 
                                Status: ${user.isActive ? 'Active' : 'Inactive'}
                            </div>
                        </div>
                        <div class="user-actions">
                            <span class="user-role role-${user.role}">
                                ${user.role.toUpperCase()}
                            </span>
                            <button class="btn-manage" onclick="manageUserBots('${user.id}', '${user.username}')">
                                <i class="fas fa-robot"></i> Bots
                            </button>
                            ${currentUser?.role === 'super_admin' ? `
                                <button class="btn-promote" onclick="promoteUser('${user.id}', '${user.username}', '${user.role}')">
                                    <i class="fas fa-user-shield"></i> Promote
                                </button>
                            ` : ''}
                            <button class="btn-delete" onclick="toggleUser('${user.id}')">
                                <i class="fas fa-power-off"></i> ${user.isActive ? 'Deactivate' : 'Activate'}
                            </button>
                        </div>
                    `;
                    usersList.appendChild(userItem);
                });
            } catch (error) {
                console.log('Error loading users:', error);
                showMessage('Error loading users', 'error');
            }
        }
        
        async function toggleUser(userId) {
            try {
                const data = await safeFetch(`/api/admin/users/${userId}/toggle`, {
                    method: 'POST'
                });
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    loadUsers();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error updating user: ' + error.message, 'error');
            }
        }
        
        // ‚úÖ FIXED PROMOTE USER FUNCTION
        async function promoteUser(userId, username, currentRole) {
            const newRole = currentRole === 'user' ? 'sub_admin' : 'user';
            const action = newRole === 'sub_admin' ? 'promote' : 'demote';
            
            const confirmMessage = `Are you sure you want to ${action} ${username} to ${newRole}?`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                showMessage(`${action === 'promote' ? 'Promoting' : 'Demoting'} user...`, 'info');
                
                const response = await fetch('/api/admin/promote-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        userId: userId,
                        newRole: newRole
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`‚úÖ ${data.message}`, 'success');
                    loadUsers(); // Refresh user list
                } else {
                    showMessage(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }
        
        // ‚úÖ FIXED BOT MANAGEMENT FUNCTIONS
        async function manageUserBots(userId, username) {
            try {
                showMessage('Loading bot details...', 'info');
                
                const response = await fetch(`/api/admin/users/${userId}/bot-details`);
                const data = await response.json();
                
                if (data.success) {
                    showBotManagementModal(userId, username, data);
                } else {
                    showMessage('Error loading bot details: ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        function showBotManagementModal(userId, username, data) {
            const modal = document.getElementById('botManagementModal');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');
            
            title.textContent = `Manage Bots - ${username}`;
            
            const currentBots = data.userBots.length;
            const isOverLimit = currentBots > 3;
            
            content.innerHTML = `
                <div style="margin-bottom: 20px;">
                    <h4>üìä Current Bots: ${currentBots} ${isOverLimit ? '<span style="color: var(--warning);">(Over Limit!)</span>' : ''}</h4>
                    ${isOverLimit ? '<p style="color: var(--warning); font-size: 0.9em;">‚ö†Ô∏è User has more than 3 bots (admin override)</p>' : ''}
                    <div style="max-height: 200px; overflow-y: auto; margin: 10px 0;">
                        ${data.userBots.length > 0 ? 
                            data.userBots.map(bot => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; margin: 5px 0;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: bold; font-size: 0.9em;">${bot.url}</div>
                                        <div style="font-size: 0.7em; opacity: 0.7;">
                                            ID: ${bot.id.substring(0, 8)}... | 
                                            Status: ${bot.enabled ? '‚úÖ Online' : '‚ùå Offline'}
                                        </div>
                                    </div>
                                    <button onclick="removeBotFromUser('${userId}', '${bot.id}', '${username}')" 
                                            style="background: var(--danger); color: white; border: none; padding: 6px 12px; border-radius: 5px; cursor: pointer; font-size: 0.8em;">
                                        üóëÔ∏è Remove
                                    </button>
                                </div>
                            `).join('') :
                            '<p style="text-align: center; opacity: 0.7; padding: 20px;">No bots allocated to this user</p>'
                        }
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4>üÜï Available Bots: ${data.availableBots.length}</h4>
                    <div style="max-height: 150px; overflow-y: auto; margin: 10px 0;">
                        ${data.availableBots.length > 0 ? 
                            data.availableBots.map(bot => `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); border-radius: 6px; margin: 3px 0;">
                                    <div style="font-size: 0.8em; flex: 1;">${bot.url}</div>
                                    <button onclick="addBotToUser('${userId}', '${bot.id}', '${username}')" 
                                            style="background: ${currentBots >= 3 ? 'var(--warning)' : 'var(--success)'}; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.7em;">
                                        ${currentBots >= 3 ? '‚ö†Ô∏è Add' : '‚ûï Add'}
                                    </button>
                                </div>
                            `).join('') :
                            '<p style="text-align: center; opacity: 0.7; font-size: 0.8em; padding: 10px;">No available bots. Add more bot instances first.</p>'
                        }
                    </div>
                    ${currentBots >= 3 ? '<p style="color: var(--warning); font-size: 0.8em; text-align: center;">‚ö†Ô∏è User already has 3+ bots. Adding more may affect performance.</p>' : ''}
                </div>
                
                <div style="text-align: center; margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
                    <button onclick="refreshBotModal('${userId}', '${username}')" 
                            style="background: var(--info); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        üîÑ Refresh
                    </button>
                    <button onclick="closeBotModal()" 
                            style="background: var(--primary); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        ‚úÖ Close
                    </button>
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        async function refreshBotModal(userId, username) {
            await manageUserBots(userId, username);
        }

        async function addBotToUser(userId, botId, username) {
            try {
                const response = await fetch(`/api/admin/users/${userId}/manage-bots`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'add_bot', botId: botId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`‚úÖ Bot added to ${username}!`, 'success');
                    await refreshBotModal(userId, username); // Refresh the modal
                    loadUsers(); // Refresh user list
                } else {
                    showMessage('‚ùå ' + data.message, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }

        // ‚úÖ FIXED BOT MANAGEMENT FUNCTIONS
        async function removeBotFromUser(userId, botId, username) {
            if (!confirm(`Are you sure you want to remove this bot from ${username}?`)) return;
            
            try {
                showMessage('Removing bot...', 'info');
                
                const response = await fetch(`/api/admin/users/${userId}/manage-bots`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'remove_bot', botId: botId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`‚úÖ ${data.message}`, 'success');
                    // Refresh the modal and user list
                    setTimeout(() => {
                        manageUserBots(userId, username);
                        loadUsers();
                    }, 1000);
                } else {
                    showMessage(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error: ' + error.message, 'error');
            }
        }

        function closeBotModal() {
            document.getElementById('botManagementModal').style.display = 'none';
        }
        
        // Bot Instances Functions
        async function addInstance() {
            const instanceUrl = document.getElementById('instanceUrl').value.trim();
            
            if (!instanceUrl) {
                showMessage('Please enter bot instance URL', 'error');
                return;
            }
            
            // Basic URL validation
            try {
                new URL(instanceUrl);
            } catch (error) {
                showMessage('Please enter a valid URL', 'error');
                return;
            }
            
            setLoading('addBtn', true);
            
            try {
                const data = await safeFetch('/api/admin/instances', {
                    method: 'POST',
                    body: JSON.stringify({
                        url: instanceUrl
                    })
                });
                
                if (data.success) {
                    showMessage('‚úÖ Bot instance added successfully!', 'success');
                    document.getElementById('instanceUrl').value = '';
                    loadInstances();
                    updateStats();
                    checkDistributionStatus();
                } else {
                    showMessage(data.message, 'error');
                }
            } catch (error) {
                showMessage('Error adding instance: ' + error.message, 'error');
            } finally {
                setLoading('addBtn', false);
            }
        }
        
        // ‚úÖ FIXED LOAD INSTANCES WITH REAL-TIME STATUS
        async function loadInstances() {
            try {
                showMessage('Loading bot instances with status...', 'info');
                
                const response = await fetch('/api/admin/instances-with-status');
                const data = await response.json();
                
                const instancesList = document.getElementById('instancesList');
                document.getElementById('instancesCount').textContent = `${data.instances.length} instances`;
                
                if (data.instances.length === 0) {
                    instancesList.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-server"></i>
                            <h3>No Bot Instances</h3>
                            <p>Add your first bot instance to get started</p>
                        </div>
                    `;
                    return;
                }
                
                instancesList.innerHTML = '';
                
                data.instances.forEach(instance => {
                    const instanceItem = document.createElement('div');
                    instanceItem.className = 'instance-item';
                    
                    const status = instance.status || {};
                    const statusBadge = status.online ? 
                        (status.running ? 'üü¢ RUNNING' : 'üü° ONLINE') : 
                        'üî¥ OFFLINE';
                        
                    const statusColor = status.online ? 
                        (status.running ? 'var(--success)' : 'var(--warning)') : 
                        'var(--danger)';

                    instanceItem.innerHTML = `
                        <div class="instance-info">
                            <div class="instance-url">${instance.url}</div>
                            <div class="instance-meta">
                                Added: ${new Date(instance.addedAt).toLocaleDateString()} | 
                                ID: ${instance.id.substring(0, 8)}... |
                                <span style="color: ${statusColor}; font-weight: bold;">${statusBadge}</span>
                                ${status.online ? `| RPS: ${status.rps} | Success: ${status.success}` : ''}
                                ${instance.allocatedTo ? ` | Allocated to: ${instance.allocatedTo}` : ' | Available'}
                            </div>
                            ${status.online ? `
                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 10px; font-size: 0.8em;">
                                    <div style="text-align: center; padding: 5px; background: rgba(72, 187, 120, 0.2); border-radius: 5px;">
                                        <div style="font-weight: bold; color: var(--success);">${status.success}</div>
                                        <div>Success</div>
                                    </div>
                                    <div style="text-align: center; padding: 5px; background: rgba(245, 101, 101, 0.2); border-radius: 5px;">
                                        <div style="font-weight: bold; color: var(--danger);">${status.fails}</div>
                                        <div>Failed</div>
                                    </div>
                                    <div style="text-align: center; padding: 5px; background: rgba(66, 153, 225, 0.2); border-radius: 5px;">
                                        <div style="font-weight: bold; color: var(--info);">${status.reqs}</div>
                                        <div>Requests</div>
                                    </div>
                                    <div style="text-align: center; padding: 5px; background: rgba(236, 201, 75, 0.2); border-radius: 5px;">
                                        <div style="font-weight: bold; color: var(--warning);">${status.rps}</div>
                                        <div>RPS</div>
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="instance-actions">
                            <button class="btn-delete" onclick="deleteInstance('${instance.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    `;
                    instancesList.appendChild(instanceItem);
                });
                
            } catch (error) {
                console.log('Error loading instances:', error);
                showMessage('Error loading instances', 'error');
            }
        }
        
        // ‚úÖ FIXED DELETE INSTANCE FUNCTION
        async function deleteInstance(instanceId) {
            if (!confirm('Are you sure you want to delete this bot instance?')) {
                return;
            }
            
            try {
                showMessage('Deleting instance...', 'info');
                
                const response = await fetch(`/api/admin/instances/${instanceId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('‚úÖ Bot instance deleted successfully!', 'success');
                    loadInstances();
                    updateStats();
                    checkDistributionStatus();
                } else {
                    showMessage(`‚ùå ${data.message}`, 'error');
                }
            } catch (error) {
                showMessage('‚ùå Error deleting instance: ' + error.message, 'error');
            }
        }
        
        // ‚úÖ BOT DISTRIBUTION FUNCTIONS
        async function checkDistributionStatus() {
            try {
                const response = await fetch('/api/admin/bot-distribution-status');
                const data = await response.json();
                
                if (data.success) {
                    const status = data.status;
                    const statusDiv = document.getElementById('distributionStatus');
                    
                    statusDiv.innerHTML = `
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center;">
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #4CAF50;">${status.availableBots}</div>
                                <div style="font-size: 0.9em;">Available Bots</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #FF9800;">${status.usersWithoutBots}</div>
                                <div style="font-size: 0.9em;">Users Without Bots</div>
                            </div>
                            <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 10px;">
                                <div style="font-size: 1.5em; font-weight: bold; color: #2196F3;">${status.usersWithPartialBots}</div>
                                <div style="font-size: 0.9em;">Users Need More Bots</div>
                            </div>
                        </div>
                        ${status.canDistribute ? 
                            '<p style="color: #4CAF50; text-align: center; margin-top: 10px;">‚úÖ Bots can be distributed to users!</p>' : 
                            '<p style="color: #FF9800; text-align: center; margin-top: 10px;">‚ö†Ô∏è No distribution needed or no available bots</p>'
                        }
                    `;
                }
            } catch (error) {
                console.log('Error checking distribution status:', error);
                document.getElementById('distributionStatus').innerHTML = `
                    <p style="color: var(--danger);">Error loading distribution status</p>
                `;
            }
        }

        async function distributeBots() {
            const btn = document.getElementById('distributeBtn');
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner"></i> Distributing...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/admin/distribute-bots', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                const resultDiv = document.getElementById('distributionResult');
                
                if (data.success) {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(76, 175, 80, 0.2); padding: 15px; border-radius: 10px; border: 1px solid #4CAF50;">
                            <h4 style="color: #4CAF50; margin: 0 0 10px 0;">‚úÖ ${data.message}</h4>
                            ${data.assigned > 0 ? `
                                <p><strong>${data.assigned} bots assigned to users:</strong></p>
                                <div style="max-height: 150px; overflow-y: auto;">
                                    ${data.log.map(item => `
                                        <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid rgba(255,255,255,0.1);">
                                            <span>${item.user}</span>
                                            <span style="color: #4CAF50;">+1 bot</span>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                    
                    // Refresh users and instances lists
                    loadUsers();
                    loadInstances();
                    checkDistributionStatus();
                    
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: rgba(244, 67, 54, 0.2); padding: 15px; border-radius: 10px; border: 1px solid #F44336;">
                            <h4 style="color: #F44336; margin: 0;">‚ùå ${data.message}</h4>
                        </div>
                    `;
                }
            } catch (error) {
                const resultDiv = document.getElementById('distributionResult');
                resultDiv.innerHTML = `
                    <div style="background: rgba(244, 67, 54, 0.2); padding: 15px; border-radius: 10px; border: 1px solid #F44336;">
                        <h4 style="color: #F44336; margin: 0;">‚ùå Distribution failed: ${error.message}</h4>
                    </div>
                `;
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Stats Update
        async function updateStats() {
            try {
                const [usersData, keysData, instancesData] = await Promise.all([
                    safeFetch('/api/admin/users'),
                    safeFetch('/api/admin/keys'),
                    safeFetch('/api/admin/instances')
                ]);
                
                if (usersData.success) {
                    document.getElementById('totalUsers').textContent = usersData.users.length;
                }
                
                if (keysData.success) {
                    document.getElementById('totalKeys').textContent = keysData.keys.length;
                }
                
                if (instancesData.success) {
                    document.getElementById('totalInstances').textContent = instancesData.instances.length;
                    document.getElementById('activeInstances').textContent = 
                        instancesData.instances.filter(inst => inst.enabled).length;
                }
            } catch (error) {
                console.log('Error updating stats:', error);
            }
        }
        
        // Load current user info
        async function loadCurrentUser() {
            try {
                const data = await safeFetch('/api/user-info');
                
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('adminUsername').textContent = data.user.username;
                    document.getElementById('adminRole').textContent = 
                        data.user.role === 'super_admin' ? 'Super Admin (Full Control)' : 
                        data.user.role === 'sub_admin' ? 'Sub Admin (Limited Control)' : 'User';
                }
            } catch (error) {
                console.log('Error loading user info:', error);
            }
        }
        
        // ‚úÖ FIXED LOGOUT FUNCTION - Only for admin.html
        async function logout() {
            console.log('üö™ Admin panel logout started...');
            
            try {
                // 1. Clear ALL local storage immediately
                localStorage.clear();
                sessionStorage.clear();
                
                // 2. Call logout API (but don't wait for response)
                fetch('/api/logout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                }).catch(err => {
                    console.log('Logout API call failed, continuing...');
                });
                
                // 3. DIRECT REDIRECT without waiting
                console.log('‚úÖ Redirecting directly to login...');
                window.location.href = '/login?message=admin_logout_success';
                
            } catch (error) {
                console.log('‚ùå Logout error, forcing redirect...');
                // EMERGENCY REDIRECT - No matter what
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login';
            }
            
            // Prevent any further execution
            return false;
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCurrentUser();
            loadKeys();
            updateStats();
            showMessage('üëë Welcome to Admin Panel!', 'success');
            
            // Check distribution status
            setTimeout(checkDistributionStatus, 2000);
        });
    </script>
</body>
</html>
